# 하드웨어 가이드 및 최적화

## 🔌 GPIO 핀 연결

### 모터 제어 핀
| 기능 | GPIO 핀 | 하드웨어 PWM | 비고 |
|------|---------|--------------|------|
| 모터 방향 (DIR) | GPIO 16 | ❌ | 디지털 출력 |
| 모터 속도 (PWM) | GPIO 12 | ✅ 채널 0 | 하드웨어 PWM 권장 |

### 서보 제어 핀
| 기능 | GPIO 핀 | 하드웨어 PWM | 비고 |
|------|---------|--------------|------|
| 서보 각도 (PWM) | GPIO 13 | ✅ 채널 1 | 하드웨어 PWM 권장 |

### 초음파 센서 핀
| 센서 | TRIG 핀 | ECHO 핀 | 비고 |
|------|---------|---------|------|
| 왼쪽 | GPIO 17 | GPIO 27 | 풀다운 저항 권장 |
| 오른쪽 | GPIO 5 | GPIO 6 | 풀다운 저항 권장 |

## ⚡ 전원 공급

### 권장 전원 구성
```
┌─────────────────┐
│  Raspberry Pi   │ ← 5V USB 전원 또는 GPIO 5V
│   (제어부)      │
└─────────────────┘
         │
         ├─ GPIO 핀들
         │
    ┌────┴────┐
    │        │
┌───▼───┐ ┌─▼────┐
│ 서보  │ │ 모터 │
│ (5V)  │ │드라이버│
└───────┘ └──┬───┘
             │
        ┌────▼────┐
        │ 배터리  │
        │ (7.4V)  │
        └─────────┘
```

### 전원 사양
- **Raspberry Pi**: 5V, 최소 2A (권장 3A)
- **서보 모터**: 5V, 1~2A (부하에 따라)
- **모터 드라이버**: 배터리 전압 (7.4V 권장), 최소 2A

### 주의사항
⚠️ **모터와 서보는 별도 전원 사용 권장**
- Raspberry Pi와 같은 전원 사용 시 전압 강하로 인한 리셋 가능
- 모터 전류가 크면 Raspberry Pi 전원에 영향

## 🔧 하드웨어 최적화 팁

### 1. PWM 최적화

#### 하드웨어 PWM 사용 (권장)
```python
# GPIO 12, 13은 하드웨어 PWM 지원
# 더 정확하고 CPU 부하 적음
PWM_PIN = 12   # 하드웨어 PWM 채널 0
SERVO_PIN = 13 # 하드웨어 PWM 채널 1
```

#### 소프트웨어 PWM (현재 사용)
- CPU 부하 있지만 유연함
- 모든 GPIO 핀 사용 가능
- 고속 제어 시 약간의 지터 가능

### 2. 초음파 센서 최적화

#### 풀다운 저항 추가
```
ECHO 핀 ──[10kΩ]── GND
         │
         └── GPIO 핀
```
- 플로팅 방지
- 노이즈 감소
- 안정적인 신호

#### 센서 배치
- 센서 간 최소 10cm 간격 권장
- 서로 수직으로 배치 (간섭 최소화)
- 모터/배터리에서 최대한 멀리

#### 케이블 관리
- 센서 케이블은 모터 케이블과 분리
- 가능하면 차폐 케이블 사용
- 길이는 최소화

### 3. 모터 드라이버 최적화

#### 드라이버 선택
- **L298N**: 저렴하지만 효율 낮음 (발열 주의)
- **TB6612FNG**: 효율 좋음, 발열 적음 (권장)
- **DRV8833**: 소형, 효율 좋음

#### 전류 용량
- 최소 2A 이상 권장
- 피크 전류 고려 (3~5A)
- 과열 보호 필요

#### 노이즈 필터
```
모터 ──[100nF]── GND
      │
      └── 드라이버
```
- 모터 근처에 커패시터 추가
- 노이즈 감소

### 4. 서보 모터 최적화

#### 서보 선택
- **금속 기어 서보**: 내구성 좋음 (권장)
- **플라스틱 기어**: 가볍지만 내구성 낮음
- **응답 속도**: 0.1~0.2초 이하 권장

#### 전원 분리
- 서보는 별도 5V 전원 권장
- Raspberry Pi와 공유 시 전압 강하 가능

#### 각도 제한
- 코드에서 45~135도로 제한
- 서보 모터 보호
- 기계적 한계 확인

### 5. 배선 최적화

#### 그라운드 연결
```
모든 GND를 공통으로 연결:
- Raspberry Pi GND
- 모터 드라이버 GND
- 서보 GND
- 센서 GND
```

#### 전원 라인
- 두꺼운 케이블 사용 (모터 전류)
- 짧게 배선 (전압 강하 최소화)
- 전원 라인과 신호 라인 분리

### 6. 노이즈 대책

#### 차폐
- 모터 케이블 차폐
- 센서 케이블 차폐
- 가능하면 트위스트 페어 케이블

#### 그라운드 루프 방지
- 단일 그라운드 포인트
- 스타 연결 방식

#### 필터링
- 전원 라인에 커패시터
- 신호 라인에 풀업/풀다운 저항

## 🔍 하드웨어 문제 해결

### 문제 1: 센서 값이 불안정
**원인:**
- 풀다운 저항 없음
- 노이즈 간섭
- 센서 간 간섭

**해결:**
1. ECHO 핀에 10kΩ 풀다운 저항 추가
2. 센서 간격 증가
3. 케이블 분리

### 문제 2: 모터가 제대로 작동 안 함
**원인:**
- 전원 부족
- 드라이버 과열
- 배선 불량

**해결:**
1. 전원 전압/전류 확인
2. 드라이버 발열 확인 (방열판 추가)
3. 배선 점검

### 문제 3: 서보가 진동함
**원인:**
- 전원 부족
- PWM 주파수 불일치
- 기계적 문제

**해결:**
1. 서보 전원 확인 (5V 안정)
2. PWM 주파수 50Hz 확인
3. 서보 마운트 확인

### 문제 4: Raspberry Pi가 리셋됨
**원인:**
- 전원 부족
- 전류 과부하
- 전압 강하

**해결:**
1. 전원 어댑터 용량 확인 (최소 3A)
2. 모터/서보 전원 분리
3. 전원 케이블 두께 확인

## 📊 성능 측정

### PWM 정확도 확인
```python
# 서보 각도 정확도 테스트
for angle in range(45, 136, 10):
    set_servo_angle(angle)
    time.sleep(0.5)
    # 실제 각도 측정
```

### 센서 응답 시간
```python
# 센서 읽기 시간 측정
start = time.time()
distance = sample_distance(TRIG, ECHO)
elapsed = time.time() - start
print(f"Sensor response: {elapsed*1000:.2f}ms")
```

### 모터 속도 일관성
```python
# PWM Duty Cycle과 실제 속도 비교
# 실제 속도는 외부 측정 필요
```

## 🛠️ 추가 개선 사항

### 1. 하드웨어 PWM 사용
```python
# pigpio 라이브러리 사용 시 하드웨어 PWM
import pigpio
pi = pigpio.pi()
pi.hardware_PWM(12, 1000, 500000)  # GPIO 12, 1kHz, 50% duty
```

### 2. 센서 멀티플렉싱
- 여러 센서를 하나의 ECHO 핀에 연결
- TRIG 핀으로 선택

### 3. 전류 모니터링
- 전류 센서 추가
- 과부하 감지 및 보호

### 4. 온도 모니터링
- 드라이버 온도 센서
- 과열 방지

## 📝 체크리스트

### 하드웨어 설정
- [ ] 모든 전원 연결 확인
- [ ] 그라운드 공통 연결
- [ ] 풀다운 저항 추가 (ECHO 핀)
- [ ] 모터/서보 전원 분리
- [ ] 배선 정리 및 고정

### 테스트
- [ ] 센서 값 안정성 확인
- [ ] 모터 정상 작동 확인
- [ ] 서보 각도 정확도 확인
- [ ] 전원 전압/전류 확인
- [ ] 노이즈 레벨 확인

### 최적화
- [ ] 하드웨어 PWM 사용 검토
- [ ] 센서 배치 최적화
- [ ] 배선 최적화
- [ ] 노이즈 필터 추가

