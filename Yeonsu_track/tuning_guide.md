# 파라미터 튜닝 가이드

## 빠른 튜닝 체크리스트

### 1단계: 기본 안정성 확인
- [ ] 진동 없이 주행하는가?
- [ ] 모드 전환이 부드러운가?
- [ ] 센서 값이 안정적인가?

### 2단계: 속도 최적화
- [ ] 직선 구간에서 충분히 빠른가?
- [ ] 곡선 구간에서 적절히 감속하는가?
- [ ] 전체 주행 시간이 개선되었는가?

### 3단계: 정밀도 향상
- [ ] 벽과의 거리가 일정한가?
- [ ] 코너에서 벽을 잘 따라가는가?
- [ ] 오버슈트가 적은가?

## 단계별 튜닝 방법

### Step 1: PID 게인 초기 설정

**RIGHT 모드부터 시작:**

```python
# 보수적인 시작값
Kp_r = 4.0
Ki_r = 0.0    # 처음에는 0으로 시작
Kd_r = 0.0    # 처음에는 0으로 시작
```

1. `Kp_r`를 0.5씩 증가시키며 테스트
2. 진동이 시작되면 이전 값으로 되돌림
3. 적절한 `Kp_r` 찾기

**Kd 추가:**
```python
Kd_r = 1.0  # Kp의 1/4 정도부터 시작
```

1. `Kd_r`를 0.2씩 증가
2. 진동이 줄어들면 적절한 값
3. 너무 높으면 노이즈에 민감해짐

**Ki 추가:**
```python
Ki_r = 0.01  # 매우 작은 값부터 시작
```

1. `Ki_r`를 0.01씩 증가
2. 정상 상태 오차가 줄어들면 적절
3. 오버슈트가 생기면 감소

### Step 2: 속도 최적화

**기본 속도 설정:**
```python
speed_base = 70.0  # 낮은 값부터 시작
```

1. 안정적으로 주행하는 최대 속도 찾기
2. 5씩 증가하며 테스트
3. 진동이나 불안정이 생기면 이전 값으로

**속도 감소 계수:**
```python
speed_angle_factor_r = 0.3  # 작은 값부터 시작
```

1. 곡선에서 속도가 너무 느리면 증가
2. 직선에서도 속도가 느리면 감소
3. 0.1씩 조정

### Step 3: 필터링 조정

**반응성 vs 안정성:**
```python
smoothing_alpha = 0.7  # 중간값부터 시작
```

- **너무 노이즈가 많으면:** 0.6으로 감소
- **반응이 너무 느리면:** 0.8로 증가
- **균형잡힌 값:** 0.75

### Step 4: 모드 전환 최적화

**전환 임계값:**
```python
right_to_left_thresh = 50.0  # 트랙에 맞게 조정
left_to_right_thresh = 20.0  # 히스테리시스 유지
```

1. 트랙에서 실제 벽이 사라지는 거리 측정
2. 그 값보다 약간 작게 설정
3. 두 값의 차이는 최소 20cm 이상 유지

**전환 지연:**
```python
mode_switch_delay = 0.2  # 짧게 시작
```

1. 채터링이 생기면 증가
2. 전환이 너무 느리면 감소
3. 0.05초 단위로 조정

## 트랙별 추천 설정

### 좁은 트랙 (폭 < 30cm)
```python
ref_distance_right = 12.0
ref_distance_left = 12.0
speed_base = 75.0
Kp_r = 5.0
Kp_l = 4.0
```

### 넓은 트랙 (폭 > 40cm)
```python
ref_distance_right = 18.0
ref_distance_left = 18.0
speed_base = 90.0
Kp_r = 7.0
Kp_l = 5.0
```

### 급커브가 많은 트랙
```python
Kd_r = 2.0  # 미분 게인 증가
Kd_l = 1.8
speed_angle_factor_r = 0.6  # 속도 감소 강화
speed_angle_factor_l = 0.5
```

### 직선이 많은 트랙
```python
speed_base = 95.0  # 최대 속도
speed_angle_factor_r = 0.3  # 속도 감소 최소화
speed_angle_factor_l = 0.25
```

## 디버깅 팁

### 로그 해석
```
[RIGHT] L:15.2 R:14.8 Err:0.20 Angle:89.5 Speed:84.2
```

- **Err (오차):** 0에 가까울수록 좋음
- **Angle:** 급격한 변화는 문제
- **Speed:** 일정하게 유지되는 것이 좋음

### 문제 진단

**진동 발생:**
- 증상: Angle이 빠르게 변화
- 해결: Kp 감소, Kd 증가, smoothing_alpha 감소

**반응 지연:**
- 증상: Err가 크게 유지됨
- 해결: Kp 증가, smoothing_alpha 증가

**모드 전환 불안정:**
- 증상: 모드가 자주 바뀜
- 해결: mode_switch_delay 증가, 임계값 차이 증가

**속도가 일정하지 않음:**
- 증상: Speed가 자주 변함
- 해결: speed_angle_factor 조정, 필터링 강화

## 고급 튜닝

### 적응형 PID (선택사항)
트랙 조건에 따라 PID 게인을 동적으로 변경할 수 있습니다.

### 속도 프로파일 최적화
곡선 반경에 따라 속도를 더 정밀하게 제어할 수 있습니다.

### 예측 제어
과거 데이터를 이용해 미래 경로를 예측하는 제어도 가능합니다.

